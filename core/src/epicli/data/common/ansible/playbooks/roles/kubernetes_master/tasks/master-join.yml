---
- delegate_to: "{{ kubernetes_common.automation_designated_master }}"
  when: not kubernetes_common.master_already_joined
  block:
    - name: Get token from master
      shell: |
        kubeadm token list \
        | grep -w authentication \
        | grep -vwi invalid \
        | awk '{print $1}' \
        | head -1
      args:
        executable: /bin/bash
      register: kubeadm_valid_token
      failed_when: kubeadm_valid_token.rc != 0 or kubeadm_valid_token.stderr  # detect errors in pipeline
      changed_when: false

    - name: Create new token
      shell: |
        kubeadm token create \
          --ttl 4h \
          --description "Token generated by Epiphany for 'kubeadm join'."
      args:
        executable: /bin/bash
      register: kubeadm_new_token
      when: not kubeadm_valid_token.stdout

    - name: Get CA key hash
      shell: |
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
        | openssl rsa -pubin -outform der 2>/dev/null \
        | openssl dgst -sha256 -hex \
        | sed 's/^.* //'
      args:
        executable: /bin/bash
      register: kubeadm_cert_hash
      changed_when: false

- when: not kubernetes_common.master_already_joined
  vars:
    kubeadm_token: >-
      {{ kubeadm_valid_token.stdout if kubeadm_valid_token.stdout else kubeadm_new_token.stdout_lines[-1] }}
    api_server_url: >-
      localhost:3446
  block:
    - name: Ensure /etc/kubeadm/ directory
      file:
        path: /etc/kubeadm/
        state: directory
        owner: root
        group: root
        mode: u=rw,go=r

    - name: Render /etc/kubeadm/kubeadm-join-master.yml template
      template:
        src: kubeadm-join-master.yml.j2
        dest: /etc/kubeadm/kubeadm-join-master.yml
        owner: root
        group: root
        mode: u=rw,go=r

    - name: Join master to ControlPlane
      shell: |
        kubeadm join \
          --config /etc/kubeadm/kubeadm-join-master.yml
      args:
        executable: /bin/bash

    - name: Mark master as joined
      set_fact:
        kubernetes_common: >-
          {{ kubernetes_common | default({}) | combine(set_fact, recursive=true) }}
      vars:
        set_fact:
          master_already_joined: true

- name: Include kubelet configuration tasks
  include_role:
    name: kubernetes_common
    tasks_from: configure-kubelet
