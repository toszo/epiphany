---
- delegate_to: "{{ automation_designated_master }}"
  when: not node_already_joined
  block:
    - name: Get token from master
      shell: |
        kubeadm token list \
        | grep -w authentication \
        | grep -vwi invalid \
        | awk '{print $1}' \
        | head -1
      args:
        executable: /bin/bash
      register: kubeadm_valid_token
      failed_when: kubeadm_valid_token.rc != 0 or kubeadm_valid_token.stderr  # detect errors in pipeline
      changed_when: false

    - name: Create new token
      shell: |
        kubeadm token create \
          --ttl 4h \
          --description "Token generated by Epiphany for 'kubeadm join'."
      args:
        executable: /bin/bash
      register: kubeadm_new_token
      when: not kubeadm_valid_token.stdout

    - name: Get CA key hash
      shell: |
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
        | openssl rsa -pubin -outform der 2>/dev/null \
        | openssl dgst -sha256 -hex \
        | sed 's/^.* //'
      args:
        executable: /bin/bash
      register: kubeadm_cert_hash
      changed_when: false

- when: not node_already_joined
  block:
    - name: Render /etc/kubeadm/kubeadm-join-node.yml template
      vars:
        kubeadm_token: >-
          {{ kubeadm_valid_token.stdout if kubeadm_valid_token.stdout else kubeadm_new_token.stdout_lines[-1] }}
        api_server_url: >-
          {%- if specification.use_ha_control_plane -%}
            localhost:3446
          {%- else -%}
            {{ hostvars[groups.kubernetes_master.0].ansible_default_ipv4.address }}:6443
          {%- endif -%}
      block:
        - name: Creates directory
          file:
            path: /etc/kubeadm/
            state: directory
            owner: root
            group: root
            mode: u=rw,go=r

        - name: Create kubeadm JoinConfiguration
          template:
            src: kubeadm-join-node.yml.j2
            dest: /etc/kubeadm/kubeadm-join-node.yml
            owner: root
            group: root
            mode: u=rw,go=r

        - block:
            - name: Join to Kubernetes cluster
              shell: |
                kubeadm join \
                  --config /etc/kubeadm/kubeadm-join-node.yml
              args:
                executable: /bin/bash
              register: kubeadm_join_result

          rescue:
            - name: Join to cluster with ignores
              shell: |
                kubeadm join \
                  --config /etc/kubeadm/kubeadm-join-node.yml \
                  --ignore-preflight-errors all
              args:
                executable: /bin/bash
              register: kubeadm_join_result

          always:
            - name: Display kubeadm join stderr if any
              debug:
                msg: |
                  Joined with warnings
                  {{ kubeadm_join_result.stderr_lines }}
              when: kubeadm_join_result is failed

            - name: Mark node regardless of join result
              set_fact:
                node_already_joined: >-
                  {{ kubeadm_join_result is succeeded }}
