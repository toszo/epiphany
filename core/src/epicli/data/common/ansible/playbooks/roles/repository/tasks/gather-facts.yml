---
- name: Produce final list of hosts to deploy repositories on
  set_fact:
    target_repository_hostnames: >-
      {{ groups.repository | difference(groups.kubernetes_master) | union([resolved_repository_hostname]) | unique }}
    # Replace repo address according to current resolved repo hostname.
    repository_url: >-
      {{ ( 'http://' ~ resolved_repository_hostname ~ '/epirepo' ) if (resolved_repository_hostname in groups.repository) else repository_url }}
  vars:
    # Applying default repo hostname (groups.repository.0) in case of old legacy clusters that used 'k8s.gcr.io'.
    resolved_repository_hostname: >-
      {{ groups.repository.0 if (resolved_repository_hostname == 'k8s.gcr.io') else resolved_repository_hostname }}
